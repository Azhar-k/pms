# .github/workflows/ci-build-property.yml

name: Property Service CI Build & Push to GHCR

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # Required for GITHUB_TOKEN to push to GHCR
    permissions:
      contents: read
      packages: write
    env:
      SERVICE_NAME: property-service
      # Define GHCR as the registry
      REGISTRY: ghcr.io
      # The image name uses the repository owner and service name
      IMAGE_NAME: ${{ github.repository_owner }}/${{ env.SERVICE_NAME }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # --- [ STEP 1: Login to GHCR ] ---

      - name: üîë Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          # The GITHUB_TOKEN is a temporary token provided by GitHub Actions
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- [ STEP 2: Build, Tag, and Push Docker Image ] ---

      - name: üìù Define Image Tags
        id: image_tags
        run: |
          # Use the full registry path for tagging
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAG_SHA="$FULL_IMAGE_NAME:${{ github.sha }}"
          TAG_LATEST="$FULL_IMAGE_NAME:latest"
          
          # Output the tags for use in the next step
          echo "TAG_SHA=$TAG_SHA" >> $GITHUB_OUTPUT
          echo "TAG_LATEST=$TAG_LATEST" >> $GITHUB_OUTPUT
          echo "Built and will push: $TAG_SHA and $TAG_LATEST"

      - name: üèóÔ∏è Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          # Context points to the folder containing the Dockerfile
          context: ${{ env.SERVICE_NAME }}
          push: true
          tags: ${{ steps.image_tags.outputs.TAG_SHA }},${{ steps.image_tags.outputs.TAG_LATEST }}
          # Use 'ghcr.io/owner/repo/service-name' format for tags

      - name: ‚úÖ Report Success
        run: echo "Successfully pushed image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} to GHCR."